{% extends "index.html" %}
{% block content %}

							<div class="row">
								<div class="col-xs-12">

									<div class="col-sm-offset-0 col-sm-12">
										<div class="well well-sm">
													<button type="button" class="close" data-dismiss="alert">&times;</button>
													&nbsp;
													<div class="inline middle blue bigger-110"> <i class="icon-wrench icon-animated-wrench bigger-150"></i>
													&nbsp;{{ user.username }},&nbsp;<strong>UserCenter</strong> </div>

													&nbsp; &nbsp; &nbsp;

												</div><!-- /well -->
										<div class="tabbable tabs-left">
											<ul class="nav nav-tabs" id="myTab3">
												<li class="active">
													<a data-toggle="tab" href="#messages">
														<i class="orange  icon-rss bigger-110"></i>
														LOGS
													</a>
												</li>

												<li>
													<a data-toggle="tab" href="#vm">
														<i class="pink  icon-bullhorn bigger-110"></i>
														My virtual machine
													</a>
												</li>

												<li>
													<a data-toggle="tab" href="#password">
														<i class="blue icon-key"></i>
														Change Password
													</a>
												</li>
											</ul>

											<div class="tab-content">
												<div id="vm" class="tab-pane">
													<div class="table-header">
														Current owned virtual machine instance
													</div>
														<div class="table-responsive">
															<table id="sample-table-2" class="table table-striped table-bordered table-hover">
																<thead>
																	<tr>
																		<th>Host machine</th>
																		<th>InstanceName</th>
																		<th>CPU</th>
																		<th>
																			<i class="icon-time bigger-110"></i>
																			RAM(MB)
																		</th>
																		<th>IPAddress</th>
																		<th>Status</th>
																		<th>Operating</th>
																	</tr>
																</thead>

																<tbody>
																{% for ds in vmList %}
																	<tr>

																		<td>
																			<a href="/viewServer/{{ds.server.id}}/">{{ ds.server.server_ip }}</a>

																		</td>
																		<td>
																			<a href="/viewInstance/{{ds.server_id}}/{{ ds.name }}/">
																			{{ ds.name }}
																			</a>
																		</td>
																		<td>{{ ds.cpu }}</td>
																		<td>{{ ds.mem }}</td>
																		{% if ds.ips %}
																			<td><code>{{ ds.ips }}</code></td>
																		{% else %}
																			<td>{{ ds.ips }}</td>
																		{% endif %}
																		<td>
														                   	{% if ds.status == 1 %}
														                   		 <i class="icon-play green"></i>
														                   	{% elif ds.status == 3 %}
														                   		 <i class="icon-pause orange"></i>
														                   	{% elif ds.status == 5 %}
														                   		 <i class="icon-stop red"></i>
														                   	{% endif %}

																		</td>

																		<td>

																			<div class="visible-md visible-lg hidden-sm hidden-xs action-buttons">


																				<a class="blue" href="/vnc/{{ ds.server_id }}/{{ ds.vnc }}/{{ ds.token }}/" target="_black">
																					<i class="icon-desktop bigger-120"></i>
																				</a>

																				<a class="blue" href="javascript:" onclick="onBtnHandleIns(this,{{ ds.server_id }},'{{ ds.name }}','start')">
																				<i class="icon-play bigger-120 green"></i>
																				</a>

																				<a class="blue" href="javascript:" onclick="onBtnHandleIns(this,{{ ds.server_id }},'{{ ds.name }}','suspend')">
																				<i class="icon-pause bigger-120 orange"></i>
																				</a>

																				<a class="blue" href="javascript:" onclick="onBtnHandleIns(this,{{ ds.server_id }},'{{ ds.name }}','resume')">
																				<i class="icon-play-circle bigger-120 "></i>
																				</a>

																				<a class="blue" href="javascript:" onclick="onBtnHandleIns(this,{{ ds.server_id }},'{{ ds.name }}','reboot')">
																					<i class="icon-repeat bigger-120"></i>
																				</a>

																				<a class="blue" href="javascript:" onclick="onBtnHandleIns(this,{{ ds.server_id }},'{{ ds.name }}','shutdown')">
																					<i class="icon-stop bigger-120 red"></i>
																				</a>

																				<a class="red" href="javascript:" onclick="onBtnHandleIns(this,{{ ds.server_id}},'{{ ds.name }}','halt')">
																					<i class="icon-off bigger-120"></i>
																				</a>

																				<a class="red" href="javascript:" onclick="onBtnHandleIns(this,{{ ds.server_id }},'{{ ds.name }}','delete')">
																					<i class="icon-trash  bigger-120"></i>
																				</a>
																				<a class="black" href="/viewInstance/{{ds.server_id}}/{{ ds.name }}/">
																					<i class="icon-zoom-in  bigger-120"></i>
																				</a>

																			</div>


																		</td>

																	</tr>
																{% endfor %}
																</tbody>
															</table>
														</div>

												</div>

												<div id="messages" class="tab-pane in active">
<!-- emre test başlangıç -->
												<div class="table-header">
													LOGS
												</div>
												<div class="table-responsive test-list">
													<table id="table-logs" class="table table-bordered table-hover dt-responsive display nowrap">
														<thead class="thead-dark">

															<tr>
																<th>
																	<label>
																		<input type="checkbox" class="ace" />
																		<span class="lbl"></span>
																	</label>
																	</th>
																<th scope="col">Status</th>
																<th>User</th>
																<th>Report</th>
																<th class="hidden-480">Virtual Machine</th>
																<th><i class="icon-time bigger-110 hidden-480"></i>Date</th>
															</tr>
														</thead>
														<tbody>
															{% for ds in logList %}
															{% if ds.isRead == 0 %}
															<tr data-id={{ds.id}}>
																<td>
																	<label>
																		<input type="checkbox" class="checkitem" name="readed" value=" {{ ds.id }} " class="ace" />
																		<span class="lbl"></span>
																	</label>
																</td>
																<td>
																	{% if ds.status == 0 %}
																	<font color="green"> success</font>
																	{% else %}
																	<font color="red">failed</font>
																	{% endif %}</td>
																<td>{{ ds.user }}</td>

																	{% if ds.status == 0 %}
																	<td>{{ ds.content }}</td>
																	{% else %}
																<td>{{ ds.content }}, {{ ds.result }}</td>
																	{% endif %}

																<td>{{ ds.vm_name}}</td>
																<td>{{ ds.create_time }}</td>
															</tr>
															{% endif %}

															{% endfor %}
														</tbody>

													</table>

													<botton id="delsel" class="btn btn-primary">
															Delete selected messages
													</botton>
													
													{% csrf_token %}

												</div>

<!-- emre test bitiş -->

													<div class="space-12"></div>

												</div>

												<div id="password" class="tab-pane">
													<div class="space-10"></div>
														<form role="form" method="post" id="modfPassword" class="main form-horizontal">{% csrf_token %}
															<div class="form-group">
																<label class="col-sm-3 control-label no-padding-right" for="form-field-pass1">New password</label>

																<div class="col-sm-9">
																	<input type="password" name='n_pwd' />
																</div>
															</div>

															<div class="space-4"></div>

															<div class="form-group">
																<label class="col-sm-3 control-label no-padding-right" for="form-field-pass2">Confirm password</label>

																<div class="col-sm-9">
																	<input type="password" name='c_pwd' />
																</div>
															</div>
															<div class="hr hr32 hr-dotted"></div>
																<div class="form-group">
																	<div class="col-md-offset-3 col-md-9">
																		<button class="btn btn-info" type="button" onclick="modAccoutPassword(this,'{{user}}','password')">
																			<i class="icon-ok bigger-110"></i>
																			Submit
																		</button>

																		&nbsp; &nbsp; &nbsp;
																		<button class="btn" type="reset">
																			<i class="icon-undo bigger-110"></i>
																			Undo
																		</button>
																	</div>
																</div>
														</form>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>

	<!-- <script src="/static/js/jquery.dataTables.min.js"></script>
	<script src="/static/js/jquery.dataTables.bootstrap.js"></script> -->
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs/dt-1.10.18/sl-1.3.0/datatables.css"/>

  <script type="text/javascript" src="https://cdn.datatables.net/v/bs/dt-1.10.18/sl-1.3.0/datatables.js"></script>
	<script type="text/javascript">


			$(document).ready(function() {
			    $('#table-logs').DataTable({
						"aoColumns": [
							{ "bSortable": false },
							null,null,null,null,null
							]
					});
			});

			$('#delsel').click(function(){
			var selected_rows = [];
			var id_list = {};
			$('.test-list').find('tr').each(function() {
				var row = $(this);
				if (row.find('input[type="checkbox"]').is(':checked')){
					if (row.attr('data-id') != null ){
						selected_rows.push(row.attr('data-id'));
					};
				};
			});
			id_list['selected_ids'] = selected_rows
			var option = {
					dataType: "JSON",
					btn: parseInt("0011",2),
					onOk: function(){
						$.ajax({
									type: 'POST',
									url: '/deleteLogs/',
									data: id_list,
										success:function(response){
														if (response["code"]=="200"){
															window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
															location.reload();													}
												else{
													window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
												}
								    },
										error:function(response){
											window.wxc.xcConfirm("Operation failed", window.wxc.xcConfirm.typeEnum.error);
										},
						});
					},
					onCancel:function(){
					},
					onClose:function(){
					}
			}
			window.wxc.xcConfirm("Do you confirm that mark as read ?", option);
		  });

			jQuery(function($) {
				var oTable1 = $('#sample-table-2').dataTable( {
				"aoColumns": [
			      { "bSortable": false },
			      null, null,null, null, null,
				  { "bSortable": false }
				] } );

				$('table th input:checkbox').on('click' , function(){
					var that = this;
					$(this).closest('table').find('tr > td:first-child input:checkbox')
					.each(function(){
						this.checked = that.checked;
						$(this).closest('tr').toggleClass('selected');
					});

				});


				$('[data-rel="tooltip"]').tooltip({placement: tooltip_placement});
				function tooltip_placement(context, source) {
					var $source = $(source);
					var $parent = $source.closest('table')
					var off1 = $parent.offset();
					var w1 = $parent.width();

					var off2 = $source.offset();
					var w2 = $source.width();

					if( parseInt(off2.left) < parseInt(off1.left) + parseInt(w1 / 2) ) return 'right';
					return 'left';
				}
			})

			function onBtnHandleIns(obj, server_id,vm_name,op){
				var btnObj = $(obj);
				if ( op == 'start'){
					var txt=  "Is it sure to start?"
				}
				else if ( op == 'shutdown'){
					var txt=  "Is it closed?"
				}
				else if( op == 'resume' ){
					var txt=  "Do you confirm recovery?"
				}
				else if( op == 'suspend' ){
					var txt=  "Do you confirm the suspension?"
				}
				else if( op == 'halt' ){
					var txt=  "Is it mandatory to close?"
				}
				else if( op == 'delete' ){
					var txt=  "Are you sure to delete?"
				}
				else if( op == 'reboot' ){
					var txt=  "Do you confirm the restart?"
				};
				var option = {
						title: "Operation host("+vm_name+")",
						btn: parseInt("0011",2),
						onOk: function(){
							$.ajax({
								  type: 'POST',
								  url: '/handleInstance/'+server_id+'/',
								  data:{
										"op":op,
										"vm_name":vm_name
									},
							      success:function(response){
						                if (response["code"]=="200"){
						                	window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);

						                }
							        	else{
							        		window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
							        	}
								},
					            error:function(response){
					            	window.wxc.xcConfirm("Operation failed", window.wxc.xcConfirm.typeEnum.error);
					            },
								});
						},
						onCancel:function(){
						},
						onClose:function(){
						}
					}
				window.wxc.xcConfirm(txt, "custom", option);
		}

			function modAccoutPassword(obj,user,op) {
				var btnObj = $(obj);
				btnObj.attr('disabled',true);
				var required = ['c_pwd','n_pwd'];
				var server_data = {};
				var form = document.getElementById('modfPassword');
				for (var i = 0; i < form.length; ++i) {
					var name = form[i].name;
					var value = form[i].value;
					idx = $.inArray(name, required);
					if (idx >= 0 && value.length == 0){
						window.wxc.xcConfirm("Please note that required fields cannot be empty~", window.wxc.xcConfirm.typeEnum.error);
						btnObj.removeAttr('disabled');
						return false;
					}
					else if(  value.length != 0 && name.length != 0 ){
						server_data[name] = value;
					};
				};
				server_data['op'] = op;
				server_data['username'] = user;
				$.ajax({
					dataType: "JSON",
					url:'/profile/', //Request address
					type:"POST",  //Submit similar
					data:server_data,  //Submit parameters
					success:function(response){
						btnObj.removeAttr('disabled');
						if (response["code"] == 200){
							window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.success);
						}
						else {
							window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
						}

					},
			    	error:function(response){
			    		btnObj.removeAttr('disabled');
			    		window.wxc.xcConfirm(response["msg"], window.wxc.xcConfirm.typeEnum.error);
			    	}
				})
			}


	</script>

{% endblock %}
